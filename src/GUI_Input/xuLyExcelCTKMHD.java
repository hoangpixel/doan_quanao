/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JDialog.java to edit this template
 */
package GUI_Input;

import BUS.ChuongTrinhKhuyenMaiHoaDonBUS;
import DTO.ChuongTrinhKhuyenMaiHoaDonDTO;
import GUI.ChuongTrinhKhuyenMaiHoaDonGUI;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import javax.swing.*;
import java.awt.*;
import java.io.*;
import java.util.ArrayList;
import java.awt.Font;
import java.util.Iterator;

/**
 *
 * @author Vinh
 */
public class xuLyExcelCTKMHD extends javax.swing.JDialog {

    /**
     * Creates new form xuLyExcelCTKMHD
     */
    ArrayList<ChuongTrinhKhuyenMaiHoaDonDTO> dskq;
    ChuongTrinhKhuyenMaiHoaDonGUI gui;
    public xuLyExcelCTKMHD(java.awt.Frame parent, boolean modal, ArrayList<ChuongTrinhKhuyenMaiHoaDonDTO> dskq, ChuongTrinhKhuyenMaiHoaDonGUI gui) {
        super(parent, modal);
        initComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel2 = new javax.swing.JPanel();
        btnGhi = new javax.swing.JButton();
        btnDoc = new javax.swing.JButton();
        jPanel1 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowOpened(java.awt.event.WindowEvent evt) {
                formWindowOpened(evt);
            }
        });

        btnGhi.setFont(new java.awt.Font("Segoe UI", 0, 16)); // NOI18N
        btnGhi.setText("Ghi");
        btnGhi.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        btnGhi.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnGhiActionPerformed(evt);
            }
        });
        jPanel2.add(btnGhi);

        btnDoc.setFont(new java.awt.Font("Segoe UI", 0, 16)); // NOI18N
        btnDoc.setText("Đọc");
        btnDoc.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        btnDoc.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnDocActionPerformed(evt);
            }
        });
        jPanel2.add(btnDoc);

        jLabel1.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        jLabel1.setText("Đọc, ghi vào Excel");
        jPanel1.add(jLabel1);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, 192, Short.MAX_VALUE)
                    .addComponent(jPanel2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void btnGhiActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnGhiActionPerformed
        JFileChooser fileChooser = new JFileChooser();
        fileChooser.setDialogTitle("Chọn nơi lưu file Excel");
        fileChooser.setSelectedFile(new File("DanhSachCTKMHD.xlsx"));

        int userSelection = fileChooser.showSaveDialog(this);
        if (userSelection != JFileChooser.APPROVE_OPTION) {
            return;
        }

        File fileToSave = fileChooser.getSelectedFile();
        String filePath = fileToSave.getAbsolutePath();
        if (!filePath.toLowerCase().endsWith(".xlsx")) {
            filePath += ".xlsx";
        }

        File existingFile = new File(filePath);
        if (existingFile.exists()) {
            int result = JOptionPane.showConfirmDialog(this,
                    "File đã tồn tại, bạn có muốn ghi đè không?",
                    "Xác nhận ghi đè",
                    JOptionPane.YES_NO_OPTION,
                    JOptionPane.WARNING_MESSAGE);
            if (result == JOptionPane.NO_OPTION) {
                return;
            }
        }

        try (Workbook workbook = new XSSFWorkbook()) {
            Sheet sheet = workbook.createSheet("Chương trình KM hóa đơn");

            // Tạo style header
            CellStyle headerStyle = workbook.createCellStyle();
            headerStyle.setAlignment(HorizontalAlignment.CENTER);
            headerStyle.setFillForegroundColor(IndexedColors.LIGHT_YELLOW.getIndex());
            headerStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND);
            headerStyle.setBorderTop(BorderStyle.THIN);
            headerStyle.setBorderBottom(BorderStyle.THIN);
            headerStyle.setBorderLeft(BorderStyle.THIN);
            headerStyle.setBorderRight(BorderStyle.THIN);

            org.apache.poi.ss.usermodel.Font headerFont = workbook.createFont();
            headerFont.setBold(true);
            headerFont.setFontHeightInPoints((short) 12);
            headerStyle.setFont(headerFont);

            // Style cho dữ liệu
            CellStyle dataStyle = workbook.createCellStyle();
            dataStyle.setBorderTop(BorderStyle.THIN);
            dataStyle.setBorderBottom(BorderStyle.THIN);
            dataStyle.setBorderLeft(BorderStyle.THIN);
            dataStyle.setBorderRight(BorderStyle.THIN);
            dataStyle.setAlignment(HorizontalAlignment.LEFT);

            CellStyle numberStyle = workbook.createCellStyle();
            numberStyle.cloneStyleFrom(dataStyle);
            numberStyle.setAlignment(HorizontalAlignment.RIGHT);

            // Header
            String[] headers = {"MACTKMHD", "MACTKM", "TONGTIENHD", "PTGG"};
            Row headerRow = sheet.createRow(0);
            for (int i = 0; i < headers.length; i++) {
                Cell cell = headerRow.createCell(i);
                cell.setCellValue(headers[i]);
                cell.setCellStyle(headerStyle);
            }

            // Dữ liệu
            ChuongTrinhKhuyenMaiHoaDonBUS bus = new ChuongTrinhKhuyenMaiHoaDonBUS();
            ArrayList<ChuongTrinhKhuyenMaiHoaDonDTO> ds = bus.layTatCaCTKMHD();

            int rowNum = 1;
            for (ChuongTrinhKhuyenMaiHoaDonDTO dto : ds) {
                Row row = sheet.createRow(rowNum++);
                int col = 0;

                Cell c0 = row.createCell(col++);
                c0.setCellValue(dto.getMaCTKMHD());
                c0.setCellStyle(numberStyle);

                Cell c1 = row.createCell(col++);
                c1.setCellValue(dto.getMaCTKM());
                c1.setCellStyle(numberStyle);

                Cell c2 = row.createCell(col++);
                c2.setCellValue(dto.getSoTienHD());
                c2.setCellStyle(numberStyle);

                Cell c3 = row.createCell(col++);
                c3.setCellValue(dto.getPhanTramGiamGia());
                c3.setCellStyle(numberStyle);
            }

            for (int i = 0; i < headers.length; i++) {
                sheet.autoSizeColumn(i);
            }

            try (FileOutputStream fos = new FileOutputStream(filePath)) {
                workbook.write(fos);
                JLabel lb = new JLabel("Xuất file Excel thành công!");
                lb.setFont(new java.awt.Font("Segoe UI", java.awt.Font.BOLD, 16));
                JOptionPane.showMessageDialog(this, lb, "Thông báo", JOptionPane.INFORMATION_MESSAGE);
            }

        } catch (IOException e) {
            JLabel lb = new JLabel("Lỗi khi ghi file: " + e.getMessage());
            lb.setFont(new java.awt.Font("Segoe UI", java.awt.Font.BOLD, 16));
            JOptionPane.showMessageDialog(this, lb, "Lỗi", JOptionPane.ERROR_MESSAGE);
            e.printStackTrace();
        }
    }//GEN-LAST:event_btnGhiActionPerformed

    private void btnDocActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnDocActionPerformed
        JFileChooser fileChooser = new JFileChooser();
        fileChooser.setDialogTitle("Chọn file Excel CTKM hóa đơn");
        fileChooser.setFileFilter(new javax.swing.filechooser.FileNameExtensionFilter("Excel files (*.xlsx)", "xlsx"));
        fileChooser.setAcceptAllFileFilterUsed(false);

        int result = fileChooser.showOpenDialog(this);
        if (result != JFileChooser.APPROVE_OPTION) {
            return;
        }

        File selectedFile = fileChooser.getSelectedFile();
        ArrayList<ChuongTrinhKhuyenMaiHoaDonDTO> excelData = readExcelCTKMHD(selectedFile);

        if (excelData == null) {
            return;
        }
        if (excelData.isEmpty()) {
            JOptionPane.showMessageDialog(this, "File Excel không có dữ liệu hợp lệ!", "Thông báo", JOptionPane.WARNING_MESSAGE);
            return;
        }

        ChuongTrinhKhuyenMaiHoaDonBUS bus = new ChuongTrinhKhuyenMaiHoaDonBUS();
        int successCount = 0, updateCount = 0, errorCount = 0;
        StringBuilder errorDetails = new StringBuilder("Các lỗi xảy ra:\n");

        for (ChuongTrinhKhuyenMaiHoaDonDTO dto : excelData) {
            try {
                if (dto.getMaCTKM() <= 0 || dto.getSoTienHD() < 0 || dto.getPhanTramGiamGia() < 0) {
                    throw new IllegalArgumentException("Dữ liệu không hợp lệ (MACTKMHD: " + dto.getMaCTKMHD() + ")");
                }

                ChuongTrinhKhuyenMaiHoaDonDTO existing = bus.layCTKMHDTheoMa(dto.getMaCTKMHD());
                if (existing != null) {
                    bus.suaCTKMHD(dto);
                    updateCount++;
                } else {
                    bus.themCTKMHD(dto);
                    successCount++;
                }
            } catch (Exception ex) {
                errorCount++;
                errorDetails.append("- Mã CTKMHD ").append(dto.getMaCTKMHD()).append(": ").append(ex.getMessage()).append("\n");
            }
        }

        bus.refreshDanhSach();

        // Thông báo kết quả
        StringBuilder message = new StringBuilder("Đọc file Excel hoàn tất!\n");
        message.append("- Tổng dòng đọc: ").append(excelData.size()).append("\n");
        message.append("- Thêm mới: ").append(successCount).append("\n");
        message.append("- Cập nhật: ").append(updateCount).append("\n");
        message.append("- Bị lỗi: ").append(errorCount);

        JLabel lb = new JLabel("<html>" + message.toString().replace("\n", "<br>") + "</html>");
        lb.setFont(new java.awt.Font("Segoe UI", java.awt.Font.PLAIN, 14));
        JOptionPane.showMessageDialog(this, lb, "Thông báo", JOptionPane.INFORMATION_MESSAGE);

        if (errorCount > 0) {
            JTextArea textArea = new JTextArea(errorDetails.toString());
            textArea.setEditable(false);
            JScrollPane scrollPane = new JScrollPane(textArea);
            scrollPane.setPreferredSize(new Dimension(400, 200));
            JOptionPane.showMessageDialog(this, scrollPane, "Chi tiết lỗi", JOptionPane.WARNING_MESSAGE);
        }
    }//GEN-LAST:event_btnDocActionPerformed

    private void formWindowOpened(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_formWindowOpened
        this.setLocationRelativeTo(getParent());
    }//GEN-LAST:event_formWindowOpened

    private ArrayList<ChuongTrinhKhuyenMaiHoaDonDTO> readExcelCTKMHD(File file) {
        ArrayList<ChuongTrinhKhuyenMaiHoaDonDTO> list = new ArrayList<>();

        try (FileInputStream fis = new FileInputStream(file); Workbook workbook = new XSSFWorkbook(fis)) {

            Sheet sheet = workbook.getSheetAt(0);
            Iterator<Row> iterator = sheet.iterator();
            if (iterator.hasNext()) {
                iterator.next(); // Bỏ dòng tiêu đề
            }
            while (iterator.hasNext()) {
                Row row = iterator.next();
                try {
                    ChuongTrinhKhuyenMaiHoaDonDTO dto = new ChuongTrinhKhuyenMaiHoaDonDTO();

                    dto.setMaCTKMHD((int) row.getCell(0).getNumericCellValue());
                    dto.setMaCTKM((int) row.getCell(1).getNumericCellValue());
                    dto.setSoTienHD((int) row.getCell(2).getNumericCellValue());
                    dto.setPhanTramGiamGia((int) row.getCell(3).getNumericCellValue());

                    list.add(dto);
                } catch (Exception e) {
                    System.err.println("Lỗi khi đọc dòng " + row.getRowNum() + ": " + e.getMessage());
                }
            }

        } catch (IOException e) {
            JOptionPane.showMessageDialog(this, "Lỗi khi đọc file Excel: " + e.getMessage(), "Lỗi", JOptionPane.ERROR_MESSAGE);
            e.printStackTrace();
            return null;
        }

        return list;
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnDoc;
    private javax.swing.JButton btnGhi;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    // End of variables declaration//GEN-END:variables
}
